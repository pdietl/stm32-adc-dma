/*
 * Copyright (c) 2021 Shlomi Vaknin
 *
 * SPDX-License-Identifier: Apache-2.0
 */

#include <math/fast_atan.h>
#include <stdint.h>

const float atanTable_f32[FAST_ATAN_TABLE_SIZE + 2] = {
  0.00000000f, 0.00195312f, 0.00390623f, 0.00585931f, 0.00781234f, 0.00976531f, 
  0.01171821f, 0.01367102f, 0.01562373f, 0.01757631f, 0.01952877f, 0.02148107f, 
  0.02343321f, 0.02538517f, 0.02733694f, 0.02928850f, 0.03123983f, 0.03319093f, 
  0.03514178f, 0.03709235f, 0.03904265f, 0.04099265f, 0.04294233f, 0.04489169f, 
  0.04684071f, 0.04878937f, 0.05073767f, 0.05268557f, 0.05463308f, 0.05658017f, 
  0.05852683f, 0.06047305f, 0.06241881f, 0.06436410f, 0.06630889f, 0.06825319f, 
  0.07019697f, 0.07214022f, 0.07408293f, 0.07602507f, 0.07796663f, 0.07990761f, 
  0.08184799f, 0.08378775f, 0.08572687f, 0.08766536f, 0.08960318f, 0.09154032f, 
  0.09347678f, 0.09541254f, 0.09734757f, 0.09928188f, 0.10121544f, 0.10314824f, 
  0.10508028f, 0.10701152f, 0.10894196f, 0.11087158f, 0.11280038f, 0.11472834f, 
  0.11665544f, 0.11858167f, 0.12050701f, 0.12243146f, 0.12435500f, 0.12627761f, 
  0.12819928f, 0.13012001f, 0.13203976f, 0.13395853f, 0.13587633f, 0.13779311f, 
  0.13970888f, 0.14162360f, 0.14353730f, 0.14544992f, 0.14736149f, 0.14927195f, 
  0.15118133f, 0.15308960f, 0.15499674f, 0.15690275f, 0.15880761f, 0.16071130f, 
  0.16261382f, 0.16451517f, 0.16641530f, 0.16831422f, 0.17021193f, 0.17210838f, 
  0.17400360f, 0.17589755f, 0.17779022f, 0.17968161f, 0.18157171f, 0.18346049f, 
  0.18534794f, 0.18723407f, 0.18911885f, 0.19100226f, 0.19288431f, 0.19476497f, 
  0.19664425f, 0.19852211f, 0.20039855f, 0.20227356f, 0.20414715f, 0.20601927f, 
  0.20788993f, 0.20975912f, 0.21162681f, 0.21349300f, 0.21535771f, 0.21722087f, 
  0.21908250f, 0.22094260f, 0.22280115f, 0.22465813f, 0.22651353f, 0.22836736f, 
  0.23021959f, 0.23207021f, 0.23391920f, 0.23576657f, 0.23761231f, 0.23945640f, 
  0.24129882f, 0.24313958f, 0.24497867f, 0.24681605f, 0.24865174f, 0.25048572f, 
  0.25231799f, 0.25414851f, 0.25597730f, 0.25780433f, 0.25962964f, 0.26145315f, 
  0.26327488f, 0.26509485f, 0.26691300f, 0.26872933f, 0.27054387f, 0.27235657f, 
  0.27416745f, 0.27597648f, 0.27778366f, 0.27958900f, 0.28139243f, 0.28319401f, 
  0.28499368f, 0.28679147f, 0.28858736f, 0.29038134f, 0.29217339f, 0.29396349f, 
  0.29575169f, 0.29753792f, 0.29932219f, 0.30110452f, 0.30288488f, 0.30466324f, 
  0.30643961f, 0.30821401f, 0.30998638f, 0.31175676f, 0.31352511f, 0.31529146f, 
  0.31705576f, 0.31881800f, 0.32057822f, 0.32233638f, 0.32409248f, 0.32584649f, 
  0.32759845f, 0.32934830f, 0.33109608f, 0.33284175f, 0.33458531f, 0.33632678f, 
  0.33806613f, 0.33980334f, 0.34153843f, 0.34327137f, 0.34500217f, 0.34673083f, 
  0.34845734f, 0.35018167f, 0.35190383f, 0.35362381f, 0.35534161f, 0.35705724f, 
  0.35877067f, 0.36048189f, 0.36219093f, 0.36389774f, 0.36560234f, 0.36730471f, 
  0.36900485f, 0.37070277f, 0.37239844f, 0.37409189f, 0.37578306f, 0.37747198f, 
  0.37915868f, 0.38084307f, 0.38252521f, 0.38420507f, 0.38588268f, 0.38755798f, 
  0.38923100f, 0.39090171f, 0.39257014f, 0.39423627f, 0.39590007f, 0.39756158f, 
  0.39922076f, 0.40087765f, 0.40253219f, 0.40418440f, 0.40583429f, 0.40748185f, 
  0.40912706f, 0.41076991f, 0.41241044f, 0.41404861f, 0.41568443f, 0.41731787f, 
  0.41894898f, 0.42057770f, 0.42220405f, 0.42382804f, 0.42544964f, 0.42706886f, 
  0.42868569f, 0.43030018f, 0.43191224f, 0.43352193f, 0.43512920f, 0.43673408f, 
  0.43833655f, 0.43993664f, 0.44153431f, 0.44312957f, 0.44472241f, 0.44631287f, 
  0.44790089f, 0.44948646f, 0.45106965f, 0.45265040f, 0.45422873f, 0.45580465f, 
  0.45737809f, 0.45894912f, 0.46051773f, 0.46208388f, 0.46364760f, 0.46520889f, 
  0.46676773f, 0.46832412f, 0.46987805f, 0.47142956f, 0.47297859f, 0.47452518f, 
  0.47606933f, 0.47761101f, 0.47915024f, 0.48068702f, 0.48222134f, 0.48375317f, 
  0.48528257f, 0.48680949f, 0.48833394f, 0.48985595f, 0.49137548f, 0.49289253f, 
  0.49440715f, 0.49591926f, 0.49742892f, 0.49893609f, 0.50044084f, 0.50194305f, 
  0.50344282f, 0.50494009f, 0.50643492f, 0.50792730f, 0.50941718f, 0.51090455f, 
  0.51238948f, 0.51387191f, 0.51535189f, 0.51682937f, 0.51830435f, 0.51977688f, 
  0.52124697f, 0.52271456f, 0.52417964f, 0.52564228f, 0.52710241f, 0.52856004f, 
  0.53001523f, 0.53146797f, 0.53291821f, 0.53436595f, 0.53581125f, 0.53725404f, 
  0.53869438f, 0.54013222f, 0.54156762f, 0.54300052f, 0.54443091f, 0.54585892f, 
  0.54728436f, 0.54870737f, 0.55012792f, 0.55154598f, 0.55296159f, 0.55437475f, 
  0.55578542f, 0.55719358f, 0.55859929f, 0.56000257f, 0.56140339f, 0.56280172f, 
  0.56419760f, 0.56559098f, 0.56698191f, 0.56837040f, 0.56975645f, 0.57114005f, 
  0.57252115f, 0.57389981f, 0.57527602f, 0.57664979f, 0.57802111f, 0.57938993f, 
  0.58075637f, 0.58212030f, 0.58348185f, 0.58484089f, 0.58619756f, 0.58755177f, 
  0.58890349f, 0.59025282f, 0.59159970f, 0.59294415f, 0.59428620f, 0.59562576f, 
  0.59696293f, 0.59829766f, 0.59963000f, 0.60095990f, 0.60228735f, 0.60361242f, 
  0.60493505f, 0.60625523f, 0.60757303f, 0.60888845f, 0.61020142f, 0.61151201f, 
  0.61282021f, 0.61412597f, 0.61542934f, 0.61673033f, 0.61802894f, 0.61932510f, 
  0.62061888f, 0.62191033f, 0.62319934f, 0.62448597f, 0.62577021f, 0.62705213f, 
  0.62833160f, 0.62960875f, 0.63088346f, 0.63215590f, 0.63342589f, 0.63469356f, 
  0.63595885f, 0.63722175f, 0.63848233f, 0.63974053f, 0.64099640f, 0.64224994f, 
  0.64350110f, 0.64474994f, 0.64599645f, 0.64724058f, 0.64848238f, 0.64972186f, 
  0.65095901f, 0.65219384f, 0.65342635f, 0.65465653f, 0.65588439f, 0.65710992f, 
  0.65833312f, 0.65955406f, 0.66077268f, 0.66198897f, 0.66320300f, 0.66441470f, 
  0.66562414f, 0.66683125f, 0.66803604f, 0.66923863f, 0.67043889f, 0.67163682f, 
  0.67283255f, 0.67402595f, 0.67521715f, 0.67640603f, 0.67759264f, 0.67877698f, 
  0.67995912f, 0.68113893f, 0.68231654f, 0.68349189f, 0.68466502f, 0.68583584f, 
  0.68700451f, 0.68817085f, 0.68933499f, 0.69049692f, 0.69165665f, 0.69281411f, 
  0.69396937f, 0.69512236f, 0.69627321f, 0.69742179f, 0.69856822f, 0.69971240f, 
  0.70085442f, 0.70199424f, 0.70313179f, 0.70426726f, 0.70540047f, 0.70653152f, 
  0.70766038f, 0.70878708f, 0.70991164f, 0.71103400f, 0.71215415f, 0.71327221f, 
  0.71438807f, 0.71550179f, 0.71661335f, 0.71772271f, 0.71882999f, 0.71993512f, 
  0.72103810f, 0.72213894f, 0.72323769f, 0.72433430f, 0.72542876f, 0.72652107f, 
  0.72761130f, 0.72869945f, 0.72978544f, 0.73086935f, 0.73195118f, 0.73303086f, 
  0.73410851f, 0.73518401f, 0.73625743f, 0.73732877f, 0.73839802f, 0.73946524f, 
  0.74053031f, 0.74159336f, 0.74265438f, 0.74371326f, 0.74477011f, 0.74582493f, 
  0.74687767f, 0.74792838f, 0.74897701f, 0.75002366f, 0.75106823f, 0.75211078f, 
  0.75315130f, 0.75418979f, 0.75522625f, 0.75626069f, 0.75729311f, 0.75832355f, 
  0.75935197f, 0.76037836f, 0.76140279f, 0.76242518f, 0.76344562f, 0.76446402f, 
  0.76548046f, 0.76649493f, 0.76750743f, 0.76851791f, 0.76952648f, 0.77053303f, 
  0.77153766f, 0.77254033f, 0.77354103f, 0.77453977f, 0.77553654f, 0.77653140f, 
  0.77752429f, 0.77851528f, 0.77950430f, 0.78049141f, 0.78147662f, 0.78245986f, 
  0.78344125f, 0.78442067f, 0.78539819f, 0.78637379f
};

float atan_f32(float x)
{
	float atanVal, fract, in;   /* Temporary input, output variables */
	uint16_t index;                 /* Index variable */
	float a, b;                 /* Two nearest output values */
	float findex;
	int32_t is_negative = 0, is_bigger_one = 0;

	in = x;

	if (in < 0) {
		in = -in;
		is_negative = 1;
	}

	if (in > 1) {
		in = 1.0f / in;
		is_bigger_one = 1;
	}

	/* Calculation of index of the table */
	findex = (float)FAST_ATAN_TABLE_SIZE * in;
	index = (uint16_t)findex;

	/* fractional value calculation */
	fract = findex - (float) index;

	/* Read two nearest values of input value from the atan table */
	a = atanTable_f32[index];
	b = atanTable_f32[index+1];

	/* Linear interpolation process */
	atanVal = (1.0f - fract) * a + fract * b;

	/* Return output value */
	if (is_bigger_one) {
		atanVal = 1.570796326794895f - atanVal;
	}

	if (is_negative) {
		atanVal = -atanVal;
	}

	return (atanVal);
}

float atan2_f32(float y, float x)
{
	if (x > 0) {
		return atan_f32(y / x);
	} else if (x == 0) {
		if (y > 0) {
			return 1.570796326794895f;
		} else {
			return -1.570796326794895f;
		}
	} else {
		if (y >= 0) {
			return atan_f32(y / x) + 3.141592653589793f;
		} else {
			return atan_f32(y / x) - 3.141592653589793f;
		}
	}
}
